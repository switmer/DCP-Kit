# DCP v3.0.0 Smoke Test Results

**Date**: 2025-11-03  
**Test Environment**: macOS, Node.js v20+, pnpm  
**Registry Source**: `onroster.app-2/src/components/ui` (56 components)

---

## üéØ Test Objective

Validate the complete end-to-end workflow for DCP v3.0.0:

1. **Extract** components from a real-world codebase
2. **Build** component packs with content-addressed blobs
3. **Serve** packs via local HTTP server
4. **Install** components using `dcp-add` (via MCP and CLI)

---

## ‚úÖ Test Results

### **Phase 1: Component Extraction**

**Command**:
```bash
dcp extract /Users/stevewitmer/local_AI_Projects/onroster.app-2/src/components/ui \
  --out /Users/stevewitmer/local_AI_Projects/onroster.app-2/registry
```

**Result**: ‚úÖ **PASS**

**Metrics**:
- **56 components** extracted
- **92.7% props coverage** (52 components with documented props)
- **Framework detection**: Next.js ‚úÖ
- **Output files**:
  - `registry.json` (56 component definitions)
  - `schemas.json` (TypeScript interfaces)
  - `metadata.json` (extraction metadata)

**Key Findings**:
- Props counting now correctly identifies objects (was showing 0% before fix)
- Framework detection correctly identifies Next.js from project root
- Project intelligence scanner now works properly with `process.cwd()`

---

### **Phase 2: Component Pack Build**

**Command** (via MCP):
```javascript
dcp_build_packs({
  registry: "/Users/stevewitmer/local_AI_Projects/onroster.app-2/registry/registry.json",
  outputDir: "/tmp/dcp-smoke-test/dist/packs",
  namespace: "ui",
  version: "0.0.1",
  baseUrl: "http://localhost:7401"
})
```

**Result**: ‚úÖ **PASS**

**Metrics**:
- **56 component packs** generated
- **Content-addressed blobs**: SHA1 hashes in `/blobs/` directory
- **Metadata quality**:
  - Each pack includes `meta.json` with:
    - Correct `registryUrl` (e.g., `/r/ui/uploadbutton`)
    - Component type, name, namespace, version
    - File references with SHA1 hashes
  - Each pack includes:
    - `index.tsx` (component code)
    - `demo.tsx` (usage example)
    - `README.md` (documentation)

**Directory Structure**:
```
/tmp/dcp-smoke-test/dist/packs/
‚îú‚îÄ‚îÄ blobs/
‚îÇ   ‚îî‚îÄ‚îÄ <sha1>.tsx (content-addressed files)
‚îú‚îÄ‚îÄ UploadButton/
‚îÇ   ‚îú‚îÄ‚îÄ meta.json
‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îú‚îÄ‚îÄ demo.tsx
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ ... (55 more component directories)
‚îî‚îÄ‚îÄ index.json (registry manifest)
```

---

### **Phase 3: Registry Server**

**Command** (via MCP):
```javascript
dcp_serve_registry({
  packsDir: "/tmp/dcp-smoke-test/dist/packs",
  port: 7401,
  host: "localhost",
  baseUrl: ""
})
```

**Result**: ‚úÖ **PASS**

**Output**:
```
Registry server running:
- Manifest: http://localhost:7401/index.json
- Components: http://localhost:7401/r/ui/<component>
- Blobs: http://localhost:7401/blobs/<sha1>
```

**Verification**:
- Server responds on `http://localhost:7401` ‚úÖ
- `index.json` manifest accessible ‚úÖ
- Component pack URLs follow `/r/:namespace/:name` pattern ‚úÖ

---

### **Phase 4: Component Installation**

#### **4.1 MCP Tool Test**

**Command** (via MCP):
```javascript
dcp_add_component({
  componentUrl: "http://localhost:7401/r/ui/uploadbutton",
  targetDir: "/tmp/dcp-app/src/components",
  force: false,
  dryRun: false
})
```

**Result**: ‚ùå **FAIL ‚Üí ‚úÖ FIXED**

**Initial Error**:
```
Error: installer.install is not a function
```

**Root Cause**:
- MCP server was importing old `dcp-add.js` instead of `dcp-add-v2.js`
- Parameter mapping was incorrect (used legacy `force` instead of `overwrite`)

**Fix Applied**:
```javascript
// Before (broken):
const { runDcpAdd } = await import('./commands/dcp-add.js');
await runDcpAdd(componentUrl, {
  force,
  noInstall: skipInstall,
  // ...
});

// After (fixed):
const { runDcpAdd } = await import('./commands/dcp-add-v2.js');
await runDcpAdd(componentUrl, {
  overwrite: force ? 'force' : 'skip',
  yes: true, // Skip prompts in MCP context
  pm: null, // Auto-detect
  // ...
});
```

**Status**: ‚úÖ **FIXED** - Ready for retest after Cursor reload

---

## üêõ Bugs Found & Fixed

### **Bug #1: MCP `dcp_add_component` Crash** ‚ö†Ô∏è **CRITICAL**

**Error**: `installer.install is not a function`

**Impact**: Blocked entire end-to-end workflow

**Fix**: Updated `mcp-server.js` to import `dcp-add-v2.js` and map parameters correctly

**Files Changed**:
- `/packages/dcp-toolkit/src/mcp-server.js` (lines 2141-2153)

**Status**: ‚úÖ **FIXED**

---

### **Bug #2: Pack Format Mismatch** ‚ö†Ô∏è **CRITICAL**

**Error**: `Invalid pack: missing files[]`

**Impact**: Installer couldn't read packs generated by `build-packs`

**Root Cause**: 
- `build-packs` was generating `files` as an **object** (dictionary)
- `dcp-add-v2` expected `files` as an **array** per DCP spec

**Fix**: Updated `build-packs.js` to generate DCP-compliant format:
```javascript
// Before (broken):
files: {
  "index.tsx": "./blobs/abc123.tsx",
  "demo.tsx": "./blobs/def456.tsx"
}

// After (fixed):
files: [
  { path: "registry/button/index.tsx", type: "registry:component", sha1: "abc123", size: 1234 },
  { path: "registry/button/demo.tsx", type: "registry:example", sha1: "def456", size: 5678 }
]
```

**Additional Changes**:
- Updated `storeBlob()` to return `{ url, sha1, size, fileName }` instead of just URL string
- Updated `dcp-add-v2.js` to extract extension from `path` when downloading blobs
- Blob URLs now correctly constructed as `/blobs/:sha1.:ext` (e.g., `/blobs/abc123.tsx`)

**Files Changed**:
- `/packages/dcp-toolkit/src/commands/build-packs.js` (lines 131-179, 574-591)
- `/packages/dcp-toolkit/src/commands/dcp-add-v2.js` (lines 288-293, 308-314)

### **Bug #3: Registry Server File Format Mismatch** ‚ö†Ô∏è **CRITICAL**

**Error**: `filePath.startsWith is not a function` (500 error)

**Impact**: Server couldn't serve component packs after format change

**Root Cause**: 
- After fixing `build-packs` to generate `files` as array, the server was still treating it as an object
- Server code was doing `Object.entries(meta.files)`, expecting object keys
- Also had duplicate baseUrl bug (`http://localhost:7401http://localhost:7401/...`)

**Fix**: Updated `serve-registry.js` to handle array format:
```javascript
// Before (broken):
const files = {};
for (const [fileName, filePath] of Object.entries(meta.files)) {
  if (filePath.startsWith('./blobs/')) {
    files[fileName] = `${this.baseUrl}/blobs/${path.basename(filePath)}`;
  }
}

// After (fixed):
// Files is now an array per DCP spec - use as-is
const files = meta.files || [];
```

**Additional Changes**:
- Fixed duplicate baseUrl in `registryUrl` (now checks if already absolute)
- Added explicit `blobsBaseUrl` to response for installer

**Files Changed**:
- `/packages/dcp-toolkit/src/commands/serve-registry.js` (lines 189-206)

**Status**: ‚úÖ **FIXED**

---

| Phase | Status | Notes |
|-------|--------|-------|
| Extract | ‚úÖ PASS | 56 components, 92.7% props coverage |
| Build Packs | ‚úÖ FIXED | Now generates DCP-compliant file arrays |
| Serve Registry | ‚úÖ FIXED | Handles new array format + duplicate baseUrl fixed |
| Install (MCP) | ‚úÖ FIXED | All 3 critical bugs resolved - ready for retest |
| Install (CLI) | ‚è≥ PENDING | Test after server restart |

---

## üöÄ Next Steps

1. **Restart registry server** with the fixed server code:
   ```bash
   # Kill existing server
   pkill -f "serve-registry"
   
   # Restart with fixed version
   npx dcp registry serve /tmp/dcp-smoke-test/dist/packs --port 7401
   ```

2. **Reload Cursor** to pick up MCP server fix

3. **Retest** `dcp_add_component` via MCP:
   ```javascript
   dcp_add_component({
     componentUrl: "http://localhost:7401/r/ui/uploadbutton",
     targetDir: "/tmp/dcp-app/src/components",
     force: false,
     dryRun: false
   })
   ```

4. **Run CLI smoke test**:
   ```bash
   npx dcp registry add http://localhost:7401/r/ui/uploadbutton \
     --target /tmp/dcp-app/src/components \
     --verbose
   ```

5. **Execute automated test script**: `./test-v3.0.0.sh`

6. **Tag release**: `v3.0.0`

---

## ‚úÖ Release Readiness

- [x] Component extraction accuracy verified
- [x] Pack build format fixed (DCP-compliant file arrays)
- [x] Registry server fixed (handles array format + duplicate baseUrl)
- [x] Critical MCP bug #1 fixed (`installer.install`)
- [x] Critical pack format bug #2 fixed (`files[]` mismatch)
- [x] Critical server bug #3 fixed (`filePath.startsWith` + duplicate baseUrl)
- [ ] Server restarted with fixed code
- [ ] End-to-end MCP installation verified (retest pending)
- [ ] CLI installation verified
- [ ] Automated test script executed
- [ ] Documentation updated
- [ ] Release notes drafted

---

**Conclusion**: The smoke test successfully identified and fixed **three critical blockers** in the v3.0.0 release:
1. MCP `dcp_add_component` tool importing wrong installer
2. Pack format mismatch between builder and installer
3. Server format mismatch handling old object format instead of new array format

After restarting the server with the fixed code and retesting, the full end-to-end workflow should be operational and ready for v3.0.0 release.

